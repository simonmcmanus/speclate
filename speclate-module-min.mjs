import sizlate from"sizlate";var asyncParallel=require("async.parallel"),getFile=require("speclate-fetch").readFile,doSizlate=require("../../lib/page/do-sizlate"),loadComponents=require("../../lib/page/load-components"),renderComponents=require("../../lib/page/render-components");function pageRender(a,b,c,d,e,f,g){asyncParallel({pageLayout:function(a){var b="/pages/"+c.page+"/"+c.page+".html";getFile(b,{encoding:"utf-8"},a)},components:function(a){c.spec?loadComponents(c,f,a):a()}},function(h,i){if(e){if(h)return void(d.error&&d.error(h,a.container));d.before&&d.before(null,null,c);const e={};e[b.container]={innerHTML:i.pageLayout},sizlate.render(a.html,e);var j=renderComponents(c,f,i.components),k=doSizlate(c,a.html,j);d.after&&d.after(null,k,c),g&&g(null,k,c)}})}var SpecFromRoute=require("./spec-from-route"),fetchJson=require("speclate-fetch").json;function pageChange(a,b,c,d){var e=d.loadingClass||"loading";c.html.classList.add(e),d.preFetch&&d.preFetch(c.container);var f=SpecFromRoute(a);c.html.setAttribute("data-speclate-url",a),window.requests&&(window.requests.forEach(function(a){a.cancel()}),window.requests=[]),window.requests.push(new function(a,b,c,d,e,f){var g=!0;return fetchJson(a,function(a,h){if(g){if(a)return b.html.classList.remove(d),f.error(a,b.container);b.html.setAttribute("data-speclate-page",h.page);var i=function(){b.html.classList.remove(d)};pageRender(b,c,h,f,g,e,i)}}),{cancel:function(){g=!1}}}(f,c,b,e,window.speclate.lists,d))}function fetchJs(a,b){var c=document.createElement("script");c.type="text/javascript",c.readyState?c.onreadystatechange=function(){("loaded"==c.readyState||"complete"==c.readyState)&&(c.onreadystatechange=null,b())}:c.onload=function(){b&&b()},c.src=a,document.getElementsByTagName("head")[0].appendChild(c)}window.requests=[];var loadLists=function(a){a.mappers.forEach(a=>fetchJs("/lists/mappers/"+a+".js")),a.filters.forEach(a=>fetchJs("/lists/filters/"+a+".js")),a.lists.forEach(a=>fetchJs("/lists/"+a+".js"))},doPopState=function(a,b,c){return function(){pageChange(document.location.pathname,b,c,a)}};const client=function(a,b,c){console.log("router loaded"),loadLists(c),b=b||{},a=a||{};const d={html:"html",container:b.container||"#container"};var e={html:document.querySelector(d.html),container:document.querySelector(d.container)};return window.addEventListener("popstate",doPopState(a,d,e)),{clickHandler:function(b){console.log("handling click");const c=b.currentTarget,f=c.getAttribute("href");if("http"!==f.slice(0,4)){b.preventDefault();window.history.pushState({},null,f),pageChange(f,d,e,a)}}}};export{client};
